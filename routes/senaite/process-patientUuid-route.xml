<routes
    xmlns="http://camel.apache.org/schema/spring">
    <route id="process-patientUuid" errorHandlerRef="watcherErrorHandler">
        <from uri="direct:process-patientUuid"/>
        
        <choice>
            <when>
                <simple>${exchangeProperty.event.tableName} == 'patient_identifier'</simple>
                <setProperty name="resourceName">
                    <simple>patient</simple>
                </setProperty>
                <setProperty name="lookUpColumn">
                    <simple>patient_id</simple>
                </setProperty>
            </when>
            <otherwise>
                <setProperty name="resourceName">
                    <simple>person</simple>
                </setProperty>
                <setProperty name="lookUpColumn">
                    <simple>person_id</simple>
                </setProperty>
            </otherwise>
        </choice>

        <toD uri="sql:SELECT uuid FROM person WHERE person_id = (SELECT t.${exchangeProperty.lookUpColumn} FROM ${exchangeProperty.event.tableName} t WHERE t.uuid = '${exchangeProperty.event.identifier}')?dataSource=openmrsDataSource" />

        <!-- TODO Check if no row was found -->

        <setProperty name="patient-uuid">
            <simple>${body[0].get('uuid')}</simple>
        </setProperty>
        
    </route>
</routes>
